generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ===== Enums =====
enum payment_room_payment_method {
  bank_transfer
  promptpay
}

enum payment_banquet_payment_method {
  bank_transfer
  promptpay
}

enum payment_room_payment_status {
  unpaid
  pending
  confirmed
  rejected
}

enum payment_banquet_payment_status {
  unpaid
  pending
  confirmed
  rejected
}

enum banquet_room_status {
  available
  occupied
  maintenance
}

enum room_status {
  available
  occupied
  maintenance
}

enum reservation_room_status {
  pending
  confirmed
  cancelled
  checked_in
  checked_out
}

enum reservation_banquet_status {
  pending
  confirmed
  cancelled
  completed
}

// ===== Tables =====

model bank_account {
  bank_account_id Int      @id @default(autoincrement())
  bank_name       String   // ตัวอย่าง: "SCB", "KBank"
  account_name    String   // ชื่อบัญชี
  account_number  String   // "123-4-56789-0"
  promptpay_id    String?  // (เผื่ออนาคต) เบอร์/เลขบัตรสำหรับ PromptPay
  is_active       Boolean  @default(true)
  is_default      Boolean  @default(false)

  created_at      DateTime? @default(now())
  updated_at      DateTime  @updatedAt

  @@unique([account_number])
  @@index([is_active, is_default])
}


model admin {
  admin_id   Int       @id @default(autoincrement())
  username   String    @unique(map: "username") @db.VarChar(50)
  password   String    @db.VarChar(255)
  full_name  String?   @db.VarChar(100)
  email      String?   @db.VarChar(100)
  phone      String?   @db.VarChar(20)
  created_at DateTime? @default(now()) @db.Timestamp(0)
  updated_at DateTime  @updatedAt
}

model banquet_room {
  banquet_id     Int                  @id @default(autoincrement())
  name           String               @db.VarChar(100)
  capacity       Int
  price_per_hour Decimal              @db.Decimal(10, 2)
  status         banquet_room_status? @default(available)
  description    String?              @db.Text
  created_at     DateTime?            @default(now()) @db.Timestamp(0)
  updated_at     DateTime             @updatedAt

  banquet_image       banquet_image[]
  reservation_banquet reservation_banquet[]
}

model banquet_image {
  image_id    Int       @id @default(autoincrement())
  banquet_id  Int
  image_url   String    @db.VarChar(255)
  description String?   @db.VarChar(255)
  created_at  DateTime? @default(now()) @db.Timestamp(0)

  banquet_room banquet_room @relation(fields: [banquet_id], references: [banquet_id], onDelete: Cascade, onUpdate: NoAction, map: "banquet_image_ibfk_1")

  @@index([banquet_id], map: "banquet_id")
}

model customer {
  customer_id Int       @id @default(autoincrement())
  first_name  String    @db.VarChar(50)
  last_name   String    @db.VarChar(50)
  phone       String @unique   @db.VarChar(20) //add_phone_unique
  email       String @unique   @db.VarChar(100) //add_email_unique
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime  @updatedAt

  reservation_banquet reservation_banquet[]
  reservation_room    reservation_room[]

  @@index([phone], map: "idx_customer_phone")
}

model room_type {
  room_type_id Int      @id @default(autoincrement())
  type_name    String   @db.VarChar(50)
  type_name_en String? @db.VarChar(100) // ชื่อ EN สำหรับโชว์ใต้ชื่อห้อง
  description  String?  @db.Text
  slug         String   @unique @db.VarChar(100)  // <<< ใช้กับ /rooms/:slug
  amenities    Json?                                // <<< รายการสิ่งอำนวยความสะดวก

  created_at   DateTime @default(now()) @db.Timestamp(0)
  updated_at   DateTime @updatedAt

  room room[]
}

model room {
  room_id      Int          @id @default(autoincrement())
  room_number  String       @unique(map: "room_number") @db.VarChar(25)
  room_type_id Int
  capacity     Int
  price        Decimal      @db.Decimal(10, 2)
  status       room_status? @default(available)
  description  String?      @db.Text
  created_at   DateTime?    @default(now()) @db.Timestamp(0)
  updated_at   DateTime     @updatedAt

  reservation_room reservation_room[]
  room_type        room_type          @relation(fields: [room_type_id], references: [room_type_id], onDelete: NoAction, onUpdate: NoAction, map: "room_ibfk_1")
  room_image       room_image[]

  @@index([room_type_id], map: "room_type_id")
}

model room_image {
  image_id    Int       @id @default(autoincrement())
  room_id     Int
  image_url   String    @db.VarChar(255)
  description String?   @db.VarChar(255)
  created_at  DateTime? @default(now()) @db.Timestamp(0)

  room room @relation(fields: [room_id], references: [room_id], onDelete: Cascade, onUpdate: NoAction, map: "room_image_ibfk_1")

  @@index([room_id], map: "room_id")
}

model reservation_room {
  reservation_id Int                      @id @default(autoincrement())
  customer_id    Int
  room_id        Int
  checkin_date   DateTime                 @db.Date
  checkout_date  DateTime                 @db.Date
  status         reservation_room_status? @default(pending)
  expires_at       DateTime? @db.Timestamp(0)  // NEW
  reservation_code String   @unique @db.VarChar(20) // NEW

  contact_name     String?   // ชื่อ ณ ตอนจอง
  contact_email    String?   // อีเมล ณ ตอนจอง
  contact_phone    String?   // เบอร์ ณ ตอนจอง

  created_at     DateTime?                @default(now()) @db.Timestamp(0)
  updated_at     DateTime                 @updatedAt
  // phone          String?                  @db.VarChar(20)
  // email          String?                  @db.VarChar(100)

  // วัน/เวลา deadine ที่ต้องชำระ (จริงๆ ใช้ expires_at ก็ได้ ถ้าคุณใช้มันเป็น deadline)
  payment_due_at        DateTime?   // แนะนำให้ set = expires_at ตอนสร้าง

  // snapshot บัญชีโอนที่แสดงให้ลูกค้า (ตอนจอง)
  pay_account_snapshot  Json?       // { bank_name, account_name, account_number, promptpay_id? }

  // (ถ้ามีเลือกวิธีชำระในอนาคต)
  // selected_payment_method String? // 'bank_transfer' | 'promptpay' | 'gateway_xxx

  payment_room payment_room[]

  customer customer @relation(fields: [customer_id], references: [customer_id], onDelete: NoAction, onUpdate: NoAction, map: "reservation_room_ibfk_1")
  room     room     @relation(fields: [room_id], references: [room_id], onDelete: NoAction, onUpdate: NoAction, map: "reservation_room_ibfk_2")

  @@index([customer_id], map: "customer_id")
  @@index([status], map: "idx_res_room_status")
  @@index([room_id, checkin_date, checkout_date], map: "idx_room_dates")
  @@index([room_id], map: "room_id")
}

model reservation_banquet {
  reservation_id Int                         @id @default(autoincrement())
  customer_id    Int
  banquet_id     Int
  event_date     DateTime                    @db.Date
  start_time     DateTime                    @db.Time(0)
  end_time       DateTime                    @db.Time(0)
  status         reservation_banquet_status? @default(pending)
  expires_at       DateTime? @db.Timestamp(0)  // NEW
  reservation_code String   @unique @db.VarChar(20)   // NEW

  contact_name     String?   // ชื่อ ณ ตอนจอง
  contact_email    String?   // อีเมล ณ ตอนจอง
  contact_phone    String?   // เบอร์ ณ ตอนจอง

  created_at     DateTime?                   @default(now()) @db.Timestamp(0)
  updated_at     DateTime                    @updatedAt
  // phone          String?                     @db.VarChar(20)
  // email          String?                     @db.VarChar(100)

  payment_due_at        DateTime?
  pay_account_snapshot  Json?

  payment_banquet payment_banquet[]

  customer     customer     @relation(fields: [customer_id], references: [customer_id], onDelete: NoAction, onUpdate: NoAction, map: "reservation_banquet_ibfk_1")
  banquet_room banquet_room @relation(fields: [banquet_id], references: [banquet_id], onDelete: NoAction, onUpdate: NoAction, map: "reservation_banquet_ibfk_2")

  @@index([banquet_id], map: "banquet_id")
  @@index([customer_id], map: "customer_id")
  @@index([banquet_id, event_date, start_time, end_time], map: "idx_banquet_datetime")
  @@index([status], map: "idx_res_banquet_status")
}

model payment_room {
  payment_id      Int                          @id @default(autoincrement())
  reservation_id  Int
  method          payment_room_payment_method  @default(bank_transfer)  // ตอนนี้ fix เป็นโอนผ่านธนาคาร
  amount          Decimal                      @db.Decimal(10, 2)
  payment_status  payment_room_payment_status  @default(pending)        // ลูกค้าอัปสลิป = pending
  slip_url        String?                      // พาธไฟล์สลิป (local/S3)
  payer_name      String?                      // ผู้โอน (optional)
  payer_bank      String?                      // ธนาคารผู้โอน (optional)
  transfer_time   DateTime?                    // เวลาโอนที่ลูกค้ากรอก (optional)
  transfer_ref    String?                      // เลขอ้างอิง/หมายเหตุ (optional)
  paid_at         DateTime?                    // แอดมินกดอนุมัติ -> ใส่ค่านี้
  created_at      DateTime?                    @default(now())
  updated_at      DateTime                     @updatedAt

  // fields สำหรับ “อนาคต” ถ้าใช้เกตเวย์: ปล่อยไว้ได้ แต่ยังไม่ใช้
  gateway_provider String?                     // 'xxx' (อนาคต)
  gateway_txn_id   String?                     // (อนาคต)
  gateway_raw      Json?                       // (อนาคต)

  reservation_room reservation_room            @relation(fields: [reservation_id], references: [reservation_id], onDelete: Cascade)

  @@index([reservation_id, payment_status])
}

model payment_banquet {
  payment_id      Int                             @id @default(autoincrement())
  reservation_id  Int
  method          payment_banquet_payment_method  @default(bank_transfer)
  amount          Decimal                         @db.Decimal(10, 2)
  payment_status  payment_banquet_payment_status  @default(pending)
  slip_url        String?
  payer_name      String?
  payer_bank      String?
  transfer_time   DateTime?
  transfer_ref    String?
  paid_at         DateTime?
  created_at      DateTime?                       @default(now())
  updated_at      DateTime                        @updatedAt

  gateway_provider String?
  gateway_txn_id   String?
  gateway_raw      Json?

  reservation_banquet reservation_banquet         @relation(fields: [reservation_id], references: [reservation_id], onDelete: Cascade)

  @@index([reservation_id, payment_status])
}
